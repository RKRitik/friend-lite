name: Robot Framework Tests

on:
  pull_request:
    paths:
      - 'tests/**/*.robot'
      - 'tests/**/*.py'
      - 'tests/run-robot-tests.sh'
      - 'backends/advanced/src/**'
      - '.github/workflows/robot-tests.yml'

permissions:
  contents: read
  pull-requests: write
  pages: write
  id-token: write

jobs:
  robot-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install Robot Framework and dependencies
      run: |
        pip install --upgrade pip
        pip install robotframework robotframework-requests python-dotenv websockets

    - name: Run Robot Framework Tests
      env:
        DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        cd tests
        chmod +x run-robot-tests.sh
        ./run-robot-tests.sh

    - name: Display test results summary
      if: always()
      run: |
        if [ -f tests/results/output.xml ]; then
          echo "### ğŸ“Š Robot Framework Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python3 << 'PYTHON_SCRIPT' >> $GITHUB_STEP_SUMMARY
        import xml.etree.ElementTree as ET
        tree = ET.parse('tests/results/output.xml')
        root = tree.getroot()
        stats = root.find('.//total/stat')
        if stats is not None:
            passed = stats.get("pass", "0")
            failed = stats.get("fail", "0")
            total = int(passed) + int(failed)
            print(f'| Metric | Count |')
            print(f'|--------|-------|')
            print(f'| âœ… Passed | {passed} |')
            print(f'| âŒ Failed | {failed} |')
            print(f'| ğŸ“Š Total | {total} |')
        PYTHON_SCRIPT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“„ **Detailed Reports**: See artifacts below or GitHub Pages (link will be added after deployment)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check if test results exist
      if: always()
      id: check_results
      run: |
        if [ -f tests/results/output.xml ]; then
          echo "results_exist=true" >> $GITHUB_OUTPUT
        else
          echo "results_exist=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ No test results found in tests/results/"
          ls -la tests/results/ || echo "Results directory doesn't exist"
        fi

    - name: Upload Robot Framework HTML reports
      if: always() && steps.check_results.outputs.results_exist == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: robot-test-reports-html
        path: |
          tests/results/report.html
          tests/results/log.html
        retention-days: 30

    - name: Publish HTML Report as GitHub Pages artifact
      if: always() && steps.check_results.outputs.results_exist == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: tests/results

    - name: Deploy to GitHub Pages
      if: always() && steps.check_results.outputs.results_exist == 'true'
      uses: actions/deploy-pages@v4
      id: deployment

    - name: Add GitHub Pages links to summary
      if: always() && steps.check_results.outputs.results_exist == 'true' && steps.deployment.outputs.page_url != ''
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š View Reports Online" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“‹ Test Report](${{ steps.deployment.outputs.page_url }}report.html)" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“ Detailed Log](${{ steps.deployment.outputs.page_url }}log.html)" >> $GITHUB_STEP_SUMMARY

    - name: Generate test summary
      if: always() && steps.check_results.outputs.results_exist == 'true'
      id: test_summary
      run: |
        # Parse test results
        python3 << 'PYTHON_SCRIPT' > test_summary.txt
        import xml.etree.ElementTree as ET
        tree = ET.parse('tests/results/output.xml')
        root = tree.getroot()
        stats = root.find('.//total/stat')
        if stats is not None:
            passed = stats.get("pass", "0")
            failed = stats.get("fail", "0")
            total = int(passed) + int(failed)
            print(f"PASSED={passed}")
            print(f"FAILED={failed}")
            print(f"TOTAL={total}")
        PYTHON_SCRIPT

        # Source the variables
        source test_summary.txt

        # Set outputs
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "total=$TOTAL" >> $GITHUB_OUTPUT

    - name: Post PR comment with test results
      if: always() && steps.check_results.outputs.results_exist == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const passed = '${{ steps.test_summary.outputs.passed }}';
          const failed = '${{ steps.test_summary.outputs.failed }}';
          const total = '${{ steps.test_summary.outputs.total }}';
          const runUrl = 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}';
          const pagesUrl = '${{ steps.deployment.outputs.page_url }}';

          const status = failed === '0' ? 'âœ… All tests passed!' : 'âŒ Some tests failed';
          const emoji = failed === '0' ? 'ğŸ‰' : 'âš ï¸';

          const comment = `## ${emoji} Robot Framework Test Results

          **Status**: ${status}

          | Metric | Count |
          |--------|-------|
          | âœ… Passed | ${passed} |
          | âŒ Failed | ${failed} |
          | ğŸ“Š Total | ${total} |

          ### ğŸ“Š View Reports

          **GitHub Pages (Live Reports):**
          - [ğŸ“‹ Test Report](${pagesUrl}report.html)
          - [ğŸ“ Detailed Log](${pagesUrl}log.html)

          **Download Artifacts:**
          - [robot-test-reports-html](${runUrl}) - HTML reports
          - [robot-test-results-xml](${runUrl}) - XML output

          ---
          *[View full workflow run](${runUrl})*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Upload Robot Framework XML output
      if: always() && steps.check_results.outputs.results_exist == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: robot-test-results-xml
        path: tests/results/output.xml
        retention-days: 30
